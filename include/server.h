/**
 * @file server.h
 * @brief Основной класс сервера
 * 
 * Определяет класс Server, который представляет собой основной серверный процесс.
 * Отвечает за инициализацию, настройку сокета, загрузку конфигурации,
 * прием клиентских подключений и создание сессий для их обработки.
 * 
 * @note Сервер работает в бесконечном цикле, принимая новые подключения
 * @see server.cpp
 */

#ifndef SERVER_H
#define SERVER_H

#include "types.h"
#include "config.h"
#include "logger.h"
#include <unordered_map>
#include <string>

/**
 * @brief Основной класс TCP сервера
 * 
 * Реализует функциональность многопользовательского TCP сервера:
 * - Загрузка конфигурации из файла
 * - Настройка и привязка сокета
 * - Прием входящих подключений
 * - Создание сессий для обработки клиентских запросов
 * - Ведение журнала событий
 * 
 * @note Использует блокирующие системные вызовы
 * @warning Обрабатывает только одно подключение одновременно (последовательно)
 */
class Server {
private:
    ServerConfig config_;                                ///< Конфигурация сервера
    Logger logger_;                                      ///< Логгер для записи событий
    std::unordered_map<std::string, std::string> clients_; ///< База данных клиентов
    int server_fd_;                                      ///< Дескриптор серверного сокета
    
    /**
     * @brief Загружает базу данных клиентов из файла
     * 
     * @throw std::runtime_error если файл не может быть открыт
     * 
     * @note Формат файла: каждая строка "логин:пароль"
     */
    void load_clients();
    
    /**
     * @brief Настраивает серверный сокет
     * 
     * Создает сокет, устанавливает опции, привязывает к адресу и порту,
     * переводит в режим прослушивания.
     * 
     * @throw std::runtime_error при ошибках системных вызовов
     */
    void setup_socket();
    
    /**
     * @brief Принимает входящие подключения
     * 
     * Бесконечный цикл, который принимает новые подключения
     * и создает для каждого экземпляр Session для обработки.
     */
    void accept_connections();
    
public:
    /**
     * @brief Конструктор сервера
     * 
     * @param config Конфигурация сервера
     * 
     * Инициализирует сервер с заданной конфигурацией:
     * 1. Создает логгер
     * 2. Загружает базу клиентов
     * 3. Настраивает сокет
     */
    Server(const ServerConfig& config);
    
    /**
     * @brief Деструктор сервера
     * 
     * Закрывает серверный сокет и освобождает ресурсы.
     */
    ~Server();
    
    /**
     * @brief Запускает основной цикл сервера
     * 
     * Выводит информацию о запуске и начинает прием подключений.
     * Работает бесконечно до принудительной остановки (Ctrl+C).
     * 
     * @note Блокирующий вызов
     */
    void run();
};

#endif
